---

  name: Build and Push Images from Release

  permissions:
    contents: write

  on:
    workflow_dispatch:
      inputs:
        release_tag:
          description: "Git reference (tag or branch) to build from (e.g., main or v1.5.0)"
          required: true
        dry_run:
          description: "Dry run (do not push images)"
          required: false
          default: "false"

  env:
    REGISTRY: docker.io
    IMAGE_OWNER: zfpsystems
    DOCKER_BUILDKIT: 1
    BUILDKIT_PROGRESS: plain

  jobs:
    build-images:
      runs-on: ubuntu-latest

      strategy:
        fail-fast: false
        matrix:
          service:
            - { name: crowler-api, dockerfile: Dockerfile.searchapi }
            - { name: crowler-events, dockerfile: Dockerfile.events }
            - { name: crowler-engine, dockerfile: Dockerfile.thecrowler }
            - { name: crowler-db, dockerfile: Dockerfile.db }

      steps:
        - name: Harden the runner (Audit all outbound calls)
          uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911

        - name: Checkout source ref (branch or tag)
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
          with:
            fetch-depth: 0
            ref: ${{ github.event.inputs.release_tag }}

        - name: Verify ref exists
          run: |
            REF="${{ github.event.inputs.release_tag }}"
            if ! git rev-parse "$REF" >/dev/null 2>&1; then
              echo "ERROR: Ref $REF does not exist!"
              exit 1
            fi

        - name: Validate Docker tag format
          run: |
            TAG="${{ github.event.inputs.release_tag }}"
            if ! [[ "$TAG" =~ ^[A-Za-z0-9_.-]+$ ]]; then
              echo "ERROR: Docker tag must be alphanumeric, dots, underscores, or hyphens."
              exit 1
            fi

        - name: Set up QEMU for cross-platform
          uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392

        - name: Set up Docker Buildx with cache
          uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435
          with:
            install: true

        - name: Log in to Docker Hub
          if: ${{ github.event.inputs.dry_run != 'true' }}
          uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PAT }}

        - name: Prepare config.yaml
          run: |
            if [ ! -f config.yaml ]; then
              mv config.default.remote config.yaml
              echo "Renamed config.default.remote to config.yaml"
            fi

        - name: Build & Push ${{ matrix.service.name }}
          run: |
            TAG="${{ github.event.inputs.release_tag }}"
            NAME="${{ matrix.service.name }}"
            DOCKERFILE="${{ matrix.service.dockerfile }}"

            if [ "$NAME" = "crowler-db" ]; then
              EXTRA_ARGS="--build-arg TIMEZONE=UTC"
            else
              EXTRA_ARGS=""
            fi

            if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
              echo "[DRY RUN] Would build $NAME:$TAG"
            else
              docker buildx build \
                --platform linux/amd64,linux/arm64 \
                -f "$DOCKERFILE" \
                $EXTRA_ARGS \
                --cache-from=type=registry,ref=$REGISTRY/$IMAGE_OWNER/$NAME:cache \
                --cache-to=type=registry,ref=$REGISTRY/$IMAGE_OWNER/$NAME:cache,mode=max \
                -t $REGISTRY/$IMAGE_OWNER/$NAME:$TAG \
                --push .

              echo "Waiting 10 seconds to avoid Docker Hub throttling..."
              sleep 10
            fi

        - name: Tag release as latest (multi-arch manifest)
          if: ${{ github.event.inputs.dry_run != 'true' }}
          run: |
            NAME="${{ matrix.service.name }}"
            TAG="${{ github.event.inputs.release_tag }}"

            echo "Waiting 5 seconds before creating manifest..."
            sleep 5

            docker buildx imagetools create \
              --tag $REGISTRY/$IMAGE_OWNER/$NAME:latest \
              $REGISTRY/$IMAGE_OWNER/$NAME:$TAG


        - name: Log out from Docker Hub
          if: ${{ github.event.inputs.dry_run != 'true' }}
          run: docker logout

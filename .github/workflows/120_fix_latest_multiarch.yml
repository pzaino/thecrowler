---

    name: "Fix Latest Multi-Arch Tags"

    on:
      workflow_dispatch:
        inputs:
          release_tag:
            description: "Tag to rebuild 'latest' from (e.g., v1.5.0)"
            required: true
          dry_run:
            description: "Run without pushing changes"
            default: "false"
            required: false

    permissions:
        contents: read

    env:
      REGISTRY: docker.io
      IMAGE_OWNER: zfpsystems

    jobs:
      retag-latest:
        runs-on: ubuntu-latest

        strategy:
          fail-fast: false
          matrix:
            service:
              - crowler-api
              - crowler-events
              - crowler-engine
              - crowler-db

        steps:
          - name: Login to Docker Hub
            if: ${{ github.event.inputs.dry_run != 'true' }}
            uses: docker/login-action@v3
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PAT }}

          - name: Set up Buildx
            uses: docker/setup-buildx-action@v3

          - name: Update latest multi-arch manifest
            run: |
              NAME="${{ matrix.service }}"
              TAG="${{ github.event.inputs.release_tag }}"

              echo "Recreating multi-arch manifest for $NAME:latest from $TAG"

              if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
                echo "[DRY RUN] Would run imagetools create for $REGISTRY/$IMAGE_OWNER/$NAME:$TAG"
              else
                docker buildx imagetools create \
                  --tag $REGISTRY/$IMAGE_OWNER/$NAME:latest \
                  $REGISTRY/$IMAGE_OWNER/$NAME:$TAG
              fi

          - name: Logout
            if: ${{ github.event.inputs.dry_run != 'true' }}
            run: docker logout
